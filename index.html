<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lomba MHQ - Musabaqoh Hifdzil Quran</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Scheherazade:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- PASSWORD MODAL -->
  <div id="passwordModal" class="password-overlay">
    <div class="password-modal">
      <div class="lock-icon">üîí</div>
      <h2>Akses Terbatas</h2>
      <p>Masukkan password untuk mengakses soal lomba MHQ.<br>Hanya untuk Juri/Panitia.</p>
      <div class="password-input-group">
        <input type="password" id="passwordInput" class="password-input" placeholder="PASSWORD" autocomplete="off">
        <button onclick="checkPassword()" class="password-btn">Masuk</button>
      </div>
      <div id="passwordError" class="password-error">Password salah! Silakan coba lagi.</div>
    </div>
  </div>

  <!-- RESET BUTTON -->
  <button id="resetBtn" class="reset-btn" onclick="resetUsedPaket()" style="display: none;">
    üîÑ Reset Data Paket
  </button>

  <!-- ACCESSIBILITY PANEL -->
  <button id="accessibilityToggle" class="accessibility-toggle" onclick="toggleAccessibilityPanel()" style="display: none;">
    ‚öôÔ∏è
  </button>
  
  <div id="accessibilityPanel" class="accessibility-panel">
    <div class="accessibility-title">‚öôÔ∏è Pengaturan Tampilan <button onclick="toggleAccessibilityPanel()" style="background: none; border: none; color: var(--gold); cursor: pointer; float: right; font-size: 1.2rem;">‚úï</button></div>
    
    <!-- Font Size -->
    <div class="accessibility-row">
      <span class="accessibility-label">Ukuran:</span>
      <div class="font-size-control">
        <button class="font-size-btn" onclick="changeFontSize(-2)">‚àí</button>
        <span id="fontSizeValue" class="font-size-value">24px</span>
        <button class="font-size-btn" onclick="changeFontSize(2)">+</button>
      </div>
    </div>
    
    <!-- Font Family -->
    <div class="accessibility-row">
      <span class="accessibility-label">Font:</span>
      <select id="fontSelect" class="font-select" onchange="changeFontFamily(this.value)">
        <option value="'Amiri', 'Traditional Arabic', serif">Amiri</option>
        <option value="'Scheherazade', 'Traditional Arabic', serif">Scheherazade</option>
        <option value="'Traditional Arabic', serif">Traditional Arabic</option>
        <option value="Arial, sans-serif">Arial</option>
      </select>
    </div>
    
    <!-- Font Color -->
    <div class="accessibility-row">
      <span class="accessibility-label">Warna:</span>
      <select id="colorSelect" class="color-select" onchange="changeFontColor(this.value)">
        <option value="#d4af37">Emas (Default)</option>
        <option value="#f4d03f">Emas Terang</option>
        <option value="#ffffff">Putih</option>
        <option value="#e8d5b7">Krem</option>
        <option value="#c9b037">Kuning Tua</option>
      </select>
    </div>
  </div>

  <header>
    <h1>üèÜ Lomba MHQ</h1>
    <p class="subtitle">Musabaqoh Hifdzil Quran - Panel Juri/Panitia</p>
  </header>

  <main>
    <!-- VIEW: DAFTAR PAKET -->
    <div id="view-daftar" class="view">
      <div class="intro">
        <h2 style="text-align: center; margin-bottom: 0.5rem; color: var(--gold);">Pilih Paket Soal</h2>
        <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;">
          Setiap peserta mendapatkan 1 paket soal yang berbeda<br>
          <small>(Paket yang sudah digunakan ditandai dengan ‚úì)</small>
        </p>
      </div>
      
      <div class="paket-grid" id="paket-grid">
        <!-- Generated by JS -->
      </div>
    </div>

    <!-- VIEW: DETAIL SOAL -->
    <div id="view-soal" class="view" style="display: none;">
      <a href="#" class="back-btn" onclick="showDaftar(); return false;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Kembali ke Daftar Paket
      </a>

      <div class="soal-container" id="soal-container">
        <!-- Generated by JS -->
      </div>
    </div>
  </main>

  <footer>
    <p>üîí Dokumen Rahasia - Hanya untuk Juri/Panitia Lomba MHQ</p>
    <p>Juz 29 & 30 (Surat Al-Mulk s.d. An-Nas)</p>
  </footer>

  <script src="data/soal.js"></script>
  <script>
    // Alias untuk UI compatibility
    const PAKET_SOAL = dataSoal;
  </script>
  <script>
    // PASSWORD PROTECTION
    const CORRECT_PASSWORD = '#mhqCRF2026!';
    const SESSION_TIMEOUT = 10 * 60 * 1000; // 10 menit dalam milliseconds
    let sessionTimer = null;
    let lastActivity = Date.now();
    
    // Track user activity
    function updateActivity() {
      lastActivity = Date.now();
      if (localStorage.getItem('mhq_authenticated') === 'true') {
        localStorage.setItem('mhq_last_activity', lastActivity);
      }
    }
    
    // Check session timeout
    function checkSessionTimeout() {
      const last = parseInt(localStorage.getItem('mhq_last_activity') || '0');
      const now = Date.now();
      
      if (now - last > SESSION_TIMEOUT) {
        // Session expired
        logout();
        return true;
      }
      return false;
    }
    
    // Logout function
    function logout() {
      localStorage.removeItem('mhq_authenticated');
      localStorage.removeItem('mhq_last_activity');
      stopSync();
      
      // Show password modal
      document.getElementById('passwordModal').style.display = 'flex';
      document.getElementById('resetBtn').style.display = 'none';
      document.getElementById('accessibilityPanel').style.display = 'none';
      document.getElementById('accessibilityPanel').classList.remove('show');
      document.getElementById('accessibilityToggle').style.display = 'none';
      document.getElementById('accessibilityToggle').classList.remove('active');
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').classList.remove('show');
      
      // Hide views
      document.getElementById('view-daftar').style.display = 'none';
      document.getElementById('view-soal').style.display = 'none';
    }
    
    // Start session timer
    function startSessionTimer() {
      if (sessionTimer) clearInterval(sessionTimer);
      sessionTimer = setInterval(() => {
        if (localStorage.getItem('mhq_authenticated') === 'true') {
          checkSessionTimeout();
        }
      }, 30000); // Check setiap 30 detik
    }
    
    // Setup activity listeners
    function setupActivityListeners() {
      const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
      events.forEach(event => {
        document.addEventListener(event, updateActivity, true);
      });
    }
    
    function checkPassword() {
      const input = document.getElementById('passwordInput').value;
      if (input === CORRECT_PASSWORD) {
        document.getElementById('passwordModal').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'block';
        document.getElementById('accessibilityToggle').style.display = 'flex';
        localStorage.setItem('mhq_authenticated', 'true');
        localStorage.setItem('mhq_last_activity', Date.now());
        setupActivityListeners();
        startSessionTimer();
        renderDaftarPaket(); // Async, no need to await here
      } else {
        document.getElementById('passwordError').classList.add('show');
        document.getElementById('passwordInput').value = '';
      }
    }
    
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') checkPassword();
    });
    
    // Cek apakah sudah authenticated
    if (localStorage.getItem('mhq_authenticated') === 'true') {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('resetBtn').style.display = 'block';
      document.getElementById('accessibilityPanel').style.display = 'flex';
    }

    // SERVER-SIDE STATE MANAGEMENT (Upstash Redis + LocalStorage sync/fallback)
    let cachedUsed = [];
    let syncInterval = null;
    const LS_KEY = 'mhq-used-paket';
    
    // Load dari LocalStorage saat init
    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem(LS_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          if (Array.isArray(data.used)) {
            cachedUsed = data.used;
            console.log('Loaded from LocalStorage:', cachedUsed);
            return cachedUsed;
          }
        }
      } catch (e) {
        console.error('LocalStorage load error:', e);
      }
      return [];
    }
    
    // Save ke LocalStorage
    function saveToLocalStorage(used) {
      try {
        localStorage.setItem(LS_KEY, JSON.stringify({ used, updatedAt: new Date().toISOString() }));
        console.log('Saved to LocalStorage:', used);
      } catch (e) {
        console.error('LocalStorage save error:', e);
      }
    }

    // Ambil state dari server (Redis primary)
    async function getUsedPaketFromServer() {
      try {
        const response = await fetch('/api/state');
        if (response.ok) {
          const data = await response.json();
          const used = data.used || [];
          console.log('Loaded from server:', used, 'source:', data.source);
          
          // Sync ke LocalStorage
          saveToLocalStorage(used);
          
          return used;
        }
      } catch (error) {
        console.error('Error fetching state from server:', error);
        // Fallback ke LocalStorage
        return loadFromLocalStorage();
      }
      return cachedUsed;
    }
    
    // Update cache dan render
    async function refreshUsedPaket() {
      // Load dari LocalStorage dulu (instant UI)
      loadFromLocalStorage();
      renderPaketCards();
      
      // Lalu sync dari server (Redis)
      const used = await getUsedPaketFromServer();
      cachedUsed = used;
      renderPaketCards();
      return used;
    }
    
    // Mark paket sebagai used (Redis primary, LocalStorage sync)
    async function markPaketUsed(id) {
      // CRITICAL: Update local FIRST immediately for persistent UI
      if (!cachedUsed.includes(id)) {
        cachedUsed.push(id);
      }
      // Save ke LocalStorage (instant)
      saveToLocalStorage(cachedUsed);
      // Render immediately - don't wait for server
      renderPaketCards();
      
      // Then sync to server in background
      try {
        const response = await fetch('/api/mark-used', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paketId: id })
        });
        
        if (response.ok) {
          const data = await response.json();
          // Update dengan data dari server (server wins)
          cachedUsed = data.used || cachedUsed;
          saveToLocalStorage(cachedUsed);
          renderPaketCards();
        }
      } catch (error) {
        console.error('Error marking paket:', error);
        // Local state already updated, UI persists
      }
    }
    
    // Reset semua paket
    async function resetUsedPaket() {
      if (!confirm('Yakin ingin reset semua data paket? Semua tanda ‚úì akan dihapus.')) {
        return;
      }
      
      // Clear LocalStorage first
      localStorage.removeItem(LS_KEY);
      cachedUsed = [];
      renderPaketCards();
      
      try {
        const response = await fetch('/api/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          alert('Data paket berhasil direset!');
        }
      } catch (error) {
        console.error('Error resetting:', error);
        alert('Gagal reset server, tapi LocalStorage sudah direset.');
      }
    }
    
    // Start polling untuk sync antar juri (tiap 3 detik)
    function startSync() {
      if (syncInterval) return;
      syncInterval = setInterval(async () => {
        if (document.getElementById('view-daftar').style.display !== 'none') {
          await refreshUsedPaket();
        }
      }, 3000);
    }
    
    // Stop polling
    function stopSync() {
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
      }
    }
    
    // Render paket cards (gunakan cachedUsed)
    function renderPaketCards() {
      const grid = document.getElementById('paket-grid');
      if (!grid) return;
      
      const used = cachedUsed;
      
      // Hanya update class, tidak re-create element jika sudah ada
      for (let i = 1; i <= 30; i++) {
        let card = document.getElementById(`paket-card-${i}`);
        
        if (!card) {
          // Create new card
          card = document.createElement('a');
          card.id = `paket-card-${i}`;
          card.href = '#';
          // Fix closure: capture i dengan IIFE
          card.onclick = ((id) => (e) => { 
            console.log('Card clicked, paket id:', id);
            e.preventDefault(); 
            showPaket(id); 
          })(i);
          card.innerHTML = `
            <span class="number">${i}</span>
            <span class="label">Paket</span>
          `;
          grid.appendChild(card);
        }
        
        // Update class
        card.className = 'paket-card' + (used.includes(i) ? ' used' : '');
      }
    }
    
    // Render daftar paket (dipanggil saat init dan showDaftar)
    async function renderDaftarPaket() {
      await refreshUsedPaket();
      startSync(); // Mulai polling
    }

    // Toggle accessibility panel
    function toggleAccessibilityPanel() {
      const panel = document.getElementById('accessibilityPanel');
      const toggle = document.getElementById('accessibilityToggle');
      
      if (panel.classList.contains('show')) {
        panel.classList.remove('show');
        toggle.classList.remove('active');
      } else {
        panel.classList.add('show');
        toggle.classList.add('active');
      }
    }

    // ACCESSIBILITY SETTINGS
    let currentFontSize = 24;
    let currentFontFamily = "'Amiri', 'Traditional Arabic', serif";
    let currentFontColor = '#d4af37';
    
    // Load saved settings
    function loadAccessibilitySettings() {
      const savedSize = localStorage.getItem('mhq_font_size');
      const savedFont = localStorage.getItem('mhq_font_family');
      const savedColor = localStorage.getItem('mhq_font_color');
      
      if (savedSize) {
        currentFontSize = parseInt(savedSize);
        updateFontSizeDisplay();
      }
      if (savedFont) {
        currentFontFamily = savedFont;
        document.getElementById('fontSelect').value = savedFont;
      }
      if (savedColor) {
        currentFontColor = savedColor;
        document.getElementById('colorSelect').value = savedColor;
      }
      
      applyAccessibilityStyles();
    }
    
    function changeFontSize(delta) {
      currentFontSize = Math.max(16, Math.min(40, currentFontSize + delta));
      localStorage.setItem('mhq_font_size', currentFontSize);
      updateFontSizeDisplay();
      applyAccessibilityStyles();
    }
    
    function updateFontSizeDisplay() {
      document.getElementById('fontSizeValue').textContent = currentFontSize + 'px';
    }
    
    function changeFontFamily(font) {
      currentFontFamily = font;
      localStorage.setItem('mhq_font_family', font);
      applyAccessibilityStyles();
    }
    
    function changeFontColor(color) {
      currentFontColor = color;
      localStorage.setItem('mhq_font_color', color);
      applyAccessibilityStyles();
    }
    
    function applyAccessibilityStyles() {
      document.documentElement.style.setProperty('--arab-font-size', currentFontSize + 'px');
      document.documentElement.style.setProperty('--arab-font-family', currentFontFamily);
      document.documentElement.style.setProperty('--arab-color', currentFontColor);
    }

    // Show daftar paket
    async function showDaftar() {
      document.getElementById('view-daftar').style.display = 'block';
      document.getElementById('view-soal').style.display = 'none';
      window.scrollTo(0, 0);
      await refreshUsedPaket();
      startSync();
    }

    // Format ayat dengan simbol pembatas antar ayat
    function formatAyatDenganPembatas(ayatArray) {
      if (!ayatArray || ayatArray.length === 0) return '';
      // Join array ayat dengan simbol €ù sebagai pemisah
      return ayatArray.join(' €ù ');
    }

    // Show detail paket
    async function showPaket(id) {
      console.log('showPaket called with id:', id, 'type:', typeof id);
      console.log('PAKET_SOAL:', PAKET_SOAL);
      console.log('First paket:', PAKET_SOAL[0]);
      const paket = PAKET_SOAL.find(p => Number(p.id) === Number(id));
      console.log('Found paket:', paket);
      console.log('Found paket:', paket);
      if (!paket) {
        console.error('Paket not found for id:', id);
        return;
      }
      
      // Stop sync saat melihat soal (hemat request)
      stopSync();
      
      // Mark sebagai used
      await markPaketUsed(id);

      const container = document.getElementById('soal-container');
      
      let soalHTML = `
        <div class="paket-header">
          <h2>
            <span>üìã</span>
            Detail Soal
          </h2>
          <span class="paket-badge">Paket ${paket.id}</span>
        </div>
      `;

      paket.soal.forEach((soal, index) => {
        let contentHTML = '';
        
        // Untuk soal Lanjutkan dan Transisi: tampilkan ayat referensi (pertanyaan)
        if (soal.tipe !== 'Lantunkan' && soal.pertanyaan) {
          const pertanyaanFormatted = formatAyatDenganPembatas([soal.pertanyaan]);
          contentHTML += `
            <div class="ayat-box">
              ${pertanyaanFormatted}
              <span class="referensi">üìñ ${soal.kunciJawaban.surah} ayat ${soal.kunciJawaban.ayat}</span>
            </div>
          `;
        }

        // Format kunci jawaban dengan simbol pembatas (gunakan teksArray)
        const kunciFormatted = formatAyatDenganPembatas(soal.kunciJawaban.teksArray || [soal.kunciJawaban.teks]);

        soalHTML += `
          <div class="soal-item">
            <div>
              <span class="soal-number">${soal.nomor}</span>
              <span class="soal-jenis">${soal.tipe}</span>
            </div>
            <p class="soal-pertanyaan">${soal.perintah}</p>
            ${contentHTML}
            
            <button class="toggle-btn" onclick="toggleKunci(this, ${paket.id}, ${index})">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              <span class="btn-text">Tampilkan Kunci Jawaban</span>
            </button>
            
            <div class="kunci-jawaban" id="kunci-${paket.id}-${index}">
              <span class="kunci-label">üîë Kunci Jawaban: ${soal.kunciJawaban.surah} ayat ${soal.kunciJawaban.ayat}</span>
              <div class="kunci-arab">${kunciFormatted}</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = soalHTML;
      
      document.getElementById('view-daftar').style.display = 'none';
      document.getElementById('view-soal').style.display = 'block';
      window.scrollTo(0, 0);
      
      // Apply accessibility styles ke elemen baru
      applyAccessibilityStyles();
    }

    // Toggle kunci jawaban
    function toggleKunci(btn, paketId, soalIndex) {
      const kunci = document.getElementById(`kunci-${paketId}-${soalIndex}`);
      const btnText = btn.querySelector('.btn-text');
      
      if (kunci.classList.contains('show')) {
        kunci.classList.remove('show');
        btn.classList.remove('active');
        btnText.textContent = 'Tampilkan Kunci Jawaban';
      } else {
        kunci.classList.add('show');
        btn.classList.add('active');
        btnText.textContent = 'Sembunyikan Kunci Jawaban';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      loadAccessibilitySettings();
      
      // Check if session expired on load
      if (localStorage.getItem('mhq_authenticated') === 'true') {
        if (checkSessionTimeout()) {
          // Session expired, will show password modal
          return;
        }
        // Session valid, restore state
        document.getElementById('passwordModal').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'block';
        document.getElementById('accessibilityToggle').style.display = 'flex';
        setupActivityListeners();
        startSessionTimer();
        await renderDaftarPaket();
      }
    });
  </script>
</body>
</html>